# MegaPlatform (SwatBloc) - Cursor Project Rules

You are working in the SwatBloc monorepo, a headless commerce platform with "Virtual Table" capabilities.

## üèó Project Structure (TurboRepo)

- **apps/web-admin**: Next.js 15 App Router dashboard for store owners.
  - Uses strictly typed `sst-env.d.ts` for bound resources.
  - Implements the "Database Manager" UI (`content/page.tsx`).
- **packages/sdk**: The public `@swatbloc/sdk` library.
  - **Version**: 1.0.x (Automated publishing via GitHub Trusted OIDC).
  - **Key Features**: Products, Cart, Checkout, **Custom DB**.
- **packages/database**: Shared SQL schema and migrations.
  - **Database**: Supabase (Postgres).
  - **Pattern**: Custom content is stored in `content_items` (JSONB) but indexed via GIN.
- **packages/mcp-server**: Model Context Protocol server for AI agents.

## üõ† Tech Stack

- **Framework**: Next.js 15 (App Router), React, Tailwind CSS.
- **Language**: TypeScript (Strict).
- **Build System**: TurboRepo + TSUP (for SDK).
- **Infrastructure**: SST (Ion) on AWS.
- **Database**: Supabase (Postgres).
- **Validation**: Zod (Runtime schema validation for custom DBs).

## üíæ Feature: Custom Databases (Virtual Tables)

We support "Virtual Tables" where users define schemas on the fly.
- **Schema Storage**: `content_models` table stores Zod-like definitions.
- **Data Storage**: `content_items` table stores data in a `data` JSONB column.
- **Indexing**: GIN indexes on `data` for fast filtering.
- **Relations**: `references` column (`text[]`) stores IDs of related items.

### SDK Usage (Updated)

The SDK now supports `swat.db` for managing these virtual tables.

```typescript
// 1. Define Model (Idempotent)
await swat.db.createModel('Waivers', 'waivers', {
  fields: [
    { key: 'email', type: 'text', required: true },
    { key: 'signed_at', type: 'date' }
  ]
});

// 2. Write Data (Auto-validated)
await swat.db.collection('waivers').create({
  email: 'user@example.com',
  signed_at: new Date().toISOString()
});

// 3. Query Data
const results = await swat.db.collection('waivers').list({
  filter: { email: 'user@example.com' }
});
```

## üöÄ CI/CD & Deployment

- **SDK Publishing**:
  - Workflow: `.github/workflows/publish-sdk.yml`
  - Auth: GitHub Actions OIDC (Trusted Publishing).
  - Trigger: Push to `main` with version bump in `packages/sdk/package.json`.
  - **Protocol**: `npm publish --provenance`.

## üìù Coding Standards

- **React**: Use Functional Components with Hooks.
- **Files**: `kebab-case` filenames.
- **Exports**: Named exports preferred over default.
- **Validation**: Zod for all API inputs and Custom DB schemas.
- **Error Handling**: Throw informative errors; UI blocks should handle gracefully.

## ‚ö†Ô∏è Important Context

- **Deployment**: We use SST. `sst dev` runs the local environment.
- **Environment**: Check `sst-env.d.ts` for available resource bindings.
- **SDK**: When editing the SDK, remember to run `npm run build` in `packages/sdk` or use `turbo build`.
